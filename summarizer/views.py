import os
import uuid
import fitz  
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.parsers import MultiPartParser
from docx import Document
from django.conf import settings
from django.shortcuts import render
from openai import OpenAI
import logging

logger = logging.getLogger(__name__)

LIARA_API_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySUQiOiI2ODNlZTE0YjdhOWYzNWZjMGRkNjc2MmQiLCJ0eXBlIjoiYXV0aCIsImlhdCI6MTc0OTEyMjM2N30.bOHDWDY1_rp6gP640UxgjnZYC-DSMAML2U3DYAlHJ-M"
LIARA_AI_BASE_URL = "https://ai.liara.ir/api/v1/683f0155f3e1bc38faca84f2"
LIARA_AI_MODEL = "google/gemini-2.0-flash-001"


def home(request):
    return render(request, 'home.html') # ูุงู ูุงู HTML ุดูุง ุงฺฏุฑ ูุชูุงูุช ุงุณุชุ ุชุบุฑ ุฏูุฏ


class PDFSummaryView(APIView):
    parser_classes = [MultiPartParser]

    def post(self, request):
        if not LIARA_API_KEY or LIARA_API_KEY == "ฺฉูุฏ_API_ูุงุฑุง_ุฎูุฏ_ุฑุง_ุงูุฌุง_ูุงุฑุฏ_ฺฉูุฏ": # ุงู ุจุฎุด ุจุฑุง ุฒูุงู ุจูุฏ ฺฉู ฺฉูุฏ ุฑุง ุฏุฑ ฺฉุฏ ูุฑุงุฑ ูโุฏุงุฏุฏ
            logger.error("ฺฉูุฏ API ูุงุฑุง ุจู ุฏุฑุณุช ุชูุธู ูุดุฏู ุงุณุช.")
            return Response({"error": "ูพฺฉุฑุจูุฏ ุณูุช ุณุฑูุฑ ุจุฑุง ฺฉูุฏ API ูุงูุต ุงุณุช."}, status=500)

        pdf_file = request.data.get('file') # ุจุฑุง MultiPartParser ุงุฒ request.data ุงุณุชูุงุฏู ฺฉูุฏ
        summary_length_percent_str = request.data.get('summary_length_percent', '50') # ูพุดโูุฑุถ ตฐูช

        if not pdf_file:
            logger.warning("ูฺ ูุงู ุฏุฑ ุฏุฑุฎูุงุณุช ุงุฑุณุงู ูุดุฏู ุงุณุช.")
            return Response({"error": "ูุงู PDF ุงุฑุณุงู ูุดุฏู ุงุณุช."}, status=400)

        try:
            summary_length_percent = int(summary_length_percent_str)
            if summary_length_percent not in [25, 50, 75]:
                logger.warning(f"ุฏุฑุตุฏ ุทูู ุฎูุงุตู ูุงูุนุชุจุฑ ุฏุฑุงูุช ุดุฏ: {summary_length_percent_str}ุ ุงุฒ ูพุดโูุฑุถ ตฐูช ุงุณุชูุงุฏู ูโุดูุฏ.")
                summary_length_percent = 50
        except ValueError:
            logger.warning(f"ููุฏุงุฑ ุบุฑ ุนุฏุฏ ุจุฑุง ุฏุฑุตุฏ ุทูู ุฎูุงุตู ุฏุฑุงูุช ุดุฏ: {summary_length_percent_str}ุ ุงุฒ ูพุดโูุฑุถ ตฐูช ุงุณุชูุงุฏู ูโุดูุฏ.")
            summary_length_percent = 50
        
        # ุชุจุฏู ุฏุฑุตุฏ ุจู ฺฉ ุนุจุงุฑุช ุชูุตู ุจุฑุง ูพุฑุงููพุช
        if summary_length_percent == 25:
            length_description = (
                "ุฎูุงุตู ุจุงุฏ ุจุณุงุฑ ฺฉูุชุงู ู ููุฌุฒ ุจุงุดุฏุ ูุนุงุฏู ุญุฏูุฏ ฒตูช ุงุฒ ุญุฌู ฺฉู ูุชู. ูุทูุงู ุชููุง ุจุฑ ูููโุชุฑู ูฺฉุงุชุ ุงุฏูโูุง ุงุตู ู ูุชุฌูโฺฏุฑ ููุง ุชูุฑฺฉุฒ ฺฉูุฏ. "
                "ูุฏูุ ุงุฑุงุฆูโ ุฏุฏ ุณุฑุน ู ูุดุฑุฏู ุงุฒ ูพุงู ุงุตู ููุณูุฏู ุงุณุช. ุงุฒ ุฐฺฉุฑ ุฌุฒุฆุงุชุ ูุซุงูโูุง ุง ุจุญุซโูุง ูุฑุน ุฎูุฏุฏุงุฑ ุดูุฏุ ูฺฏุฑ ุขูฺฉู ุจุฑุง ุฏุฑฺฉ ุงุฏูโ ุงุตู ฺฉุงููุงู ุถุฑูุฑ ุจุงุดูุฏ."
            )

        elif summary_length_percent == 75:
            length_description = (
                "ุฎูุงุตู ุจุงุฏ ุฌุงูุน ู ุจุง ุฌุฒุฆุงุช ูุฑุงูุงู ุจุงุดุฏุ ูุนุงุฏู ุญุฏูุฏ ทตูช ุงุฒ ูุญุชูุง ูุชู ุงุตู. ูุทูุงู ุจูโุตูุฑุช ุฏูู ู ฺฉุงูู ุจู ุชูุงู ุจุฎุดโูุง ุจูพุฑุฏุงุฒุฏุ "
                "ู ูฺฉุงุช ฺฉูุฏุ ุฌุฒุฆุงุช ูููุ ุงุณุชุฏูุงูโูุง ู ุฏุฑ ุตูุฑุช ูุฒููุ ูุซุงูโูุง ุง ุฏุงุฏูโูุง ูพุดุชุจุงู ุฑุง ูุฒ ุฐฺฉุฑ ฺฉูุฏ. "
                "ูุฏูุ ุงุฑุงุฆูโ ุจุงุฒููุงโุง ูุฒุฏฺฉ ุจู ูุชู ฺฉุงูู ุงุณุช."
            )

        else:  # summary_length_percent == 50 or default
            length_description = (
                "ุฎูุงุตู ุจุงุฏ ูุชุนุงุฏู ู ุจุง ูพูุดุด ฺฉู ุงุฒ ูุชู ุจุงุดุฏุ ุฏุฑ ุญุฏูุฏ ตฐูช ุงุฒ ุญุฌู ฺฉู. ูุทูุงู ุจู ุจุฎุดโูุง ุงุตู ุงุดุงุฑู ฺฉูุฏ ู ูฺฉุงุช ฺฉูุฏุ ุฌุฒุฆุงุช ููู ู ุงุณุชุฏูุงูโูุง ุงุตู ุฑุง ูุฒ ูุญุงุธ ฺฉูุฏ. "
                "ูุฏูุ ุงุฑุงุฆูโ ุฏุฑฺฉ ฺฉุงูู ู ููุงุณุจ ุงุฒ ูุญุชูุง ุงุณุชุ ุจุฏูู ูุฑูุฏ ุจู ุฌุฒุฆุงุช ุฑุฒ ุง ููุถูุนุงุช ูุฑุน."
            )

                


        original_filename = pdf_file.name
        logger.info(f"ุดุฑูุน ูพุฑุฏุงุฒุด ูุงู: {original_filename} ุจุง ุฏุฑุฎูุงุณุช ุทูู ุฎูุงุตู: {summary_length_percent}%")
        raw_text = ""

        try:
            pdf_bytes = pdf_file.read()
            doc = fitz.open(stream=pdf_bytes, filetype="pdf")
            for page_num in range(len(doc)):
                page = doc.load_page(page_num)
                raw_text += page.get_text(sort=True) + "\n"
            doc.close()

            logger.info(f"--- ูุชู ุงุณุชุฎุฑุงุฌ ุดุฏู ุงุฒ '{original_filename}' (ฒฐฐฐ ฺฉุงุฑุงฺฉุชุฑ ุงูู) ---")
            logger.info(raw_text[:2000] if raw_text else "ูุชู ุงุณุชุฎุฑุงุฌ ูุดุฏ ุง ูุชู ุฎุงู ุงุณุช")
            logger.info("--- ูพุงุงู ูุชู ุงุณุชุฎุฑุงุฌ ุดุฏู ---")

            if not raw_text.strip():
                logger.warning(f"ูุชู ุงุฒ ูุงู PDF '{original_filename}' ุงุณุชุฎุฑุงุฌ ูุดุฏ.")
                return Response({"error": "ูุชู ุงุฒ ูุงู PDF ุงุณุชุฎุฑุงุฌ ูุดุฏ. ููฺฉู ุงุณุช ูุงู ุชุตูุฑ ุจุงุดุฏ ุง ูุญุชูุง ูุชู ูุฏุงุดุชู ุจุงุดุฏ."}, status=400)
        except Exception as e:
            logger.error(f"ุฎุทุง ุฏุฑ ูพุฑุฏุงุฒุด ูุงู PDF '{original_filename}' ุจุง PyMuPDF: {e}", exc_info=True)
            return Response({"error": f"ุฎุทุง ุฏุฑ ุฎูุงูุฏู ุง ูพุฑุฏุงุฒุด ูุงู PDF: {e}"}, status=500)

        try:
            client = OpenAI(
                base_url=LIARA_AI_BASE_URL,
                api_key=LIARA_API_KEY,
            )
            
            prompt_content = f"""๐ ููุด ุดูุง:
            ุดูุง ฺฉ ูุฏู ุฒุจุงู ุจุฒุฑฺฏ (LLM) ูุณุชุฏ ฺฉู ููุด ฺฉ ุชุญููฺฏุฑ ุฒุจุงูโุดูุงุณุ ุฎูุงุตูโุณุงุฒ ุชุฎุตุตุ ูุชุฑุฌู ุญุฑููโุง ู ูพุฑุฏุงุฒุดฺฏุฑ ุฏูู ุงุณูุงุฏ PDF ุฑุง ุงูุง ูโฺฉูุฏ. ูุฏู ุดูุง ุฏุฑุงูุช ูุงู PDF ุขูพููุฏุดุฏู ุชูุณุท ฺฉุงุฑุจุฑุ ุจุฑุฑุณ ุฒุจุงู ู ุณุงุฎุชุงุฑ ุขูุ ูพุฑุฏุงุฒุด ุฏูู ูุญุชูุง ูุชูุ ุชุฑุฌูู ุฏุฑ ุตูุฑุช ูุงุฒุ ู ุงุฑุงุฆู ฺฉ ุฎูุงุตูโ ุฏููุ ุญุฑููโุง ู ุณุงุฎุชุงุฑุงูุชู ุงุณุช ฺฉู ุจูโุตูุฑุช ุฑูุงู ู ููุฏ ุจุฑุง ฺฉุงุฑุจุฑ ูุงุฑุณโุฒุจุงู ุงุฑุงุฆู ูโุดูุฏ.
            ๐ ุณูุงุฑู ุนููุงุช:
            ฺฉุงุฑุจุฑ ฺฉ ูุงู PDF ุขูพููุฏ ูโฺฉูุฏ ฺฉู ููฺฉู ุงุณุช ุดุงูู ูุชูู ูุงุฑุณ ุง ุงูฺฏูุณ ุง ุณุงุฑ ุฒุจุงูโูุง ุจูโุงูููู ุจุงุดุฏ. ูุงู ูโุชูุงูุฏ ุดุงูู ูุญุชูุง ุนููุ ุชุญููุงุชุ ฺฉุชุงุจุ ููุงููุ ุฏุณุชูุฑุงูุนููุ ฺฏุฒุงุฑุด ุฑุณูุ ุง ุญุช ุฑูุงู ุจุงุดุฏ. ุณุณุชู ุดูุง ุจุงุฏ ฺฉุงููุงู ุจุงูุช ู ุฒุจุงู ุณูุฏ ุฑุง ุฏุฑฺฉ ฺฉุฑุฏูุ ูุทุงุจู ุฏุณุชูุฑุงูุนููโูุง ุฒุฑ ูุงฺฉูุด ูุดุงู ุฏูุฏ:
            ---
            ## ๐ฏ ุฏุณุชูุฑุงูุนููโูุง ุชุญูู ู ูพุงุณุฎ:
            ### 1. ุชุดุฎุต ุฒุจุงู ุงููู ูุงู:
            - ูุงู PDF ุฑุง ุจุฑุฑุณ ฺฉู ู ุฒุจุงู ูุชู ุบุงูุจ ุฑุง ูุดุฎุต ฺฉู.
            - ุงฺฏุฑ ูุงู ฺูุฏุฒุจุงูู ุงุณุชุ ุฒุจุงู ุจุฎุดโูุง ูุฎุชูู ุฑุง ุฌุฏุงฺฏุงูู ุดูุงุณุง ู ุนูุงูุชโฺฏุฐุงุฑ ฺฉู.
            - ููุท ุจู ุฒุจุงู ูุชู ุชูุฌู ฺฉูุ ูู ุฒุจุงู ูุชุงุฏุชุง ุง ุนูุงูู ูุงู.
            ### 2. ูพุฑุฏุงุฒุด ูุชูู ูุงุฑุณ:
            - ุงฺฏุฑ ุฒุจุงู ุงุตู ูุงู ูุงุฑุณ ุงุณุช:
            - ูุชู ุฑุง ุจูโุทูุฑ ฺฉุงูู ูพุฑุฏุงุฒุด ฺฉู.
            - ุณุงุฎุชุงุฑ ููุทู ูุชู (ููุฏููุ ุจุฏููุ ูุชุฌูโฺฏุฑุ ูุตูโุจูุฏ ู ...) ุฑุง ุงุณุชุฎุฑุงุฌ ฺฉู.
            - ฺฉ ุฎูุงุตูโ **ฺฉุงููุ ุฏููุ ููุงุฏุงุฑ ู ุฑูุงู** ุชููุฏ ฺฉู ฺฉู:
                - ููุงูู ฺฉูุฏ ุฑุง ุญูุธ ฺฉูุฏ.
                - ุชุฑุชุจ ููุทู ูุทุงูุจ ุฑุง ุฑุนุงุช ฺฉูุฏ.
                - **ุทูู ุฎูุงุตู ุจุงุฏ {length_description} ุจุงุดุฏ.**
                - ุงุฒ ุณุงุฏูโุณุงุฒ ุจุดโุงุฒุญุฏ ูพุฑูุฒ ุดูุฏ.
                - ูพุงู ููุณูุฏู ู ูุฏู ูุฑ ุจุฎุด ุฏุฑ ุฎูุงุตู ููุนฺฉุณ ุดูุฏ.
                - ุงุฒ ูููโูููุ ูุซุงูโูุง ุง ุขูุงุฑ ููู ุฏุฑ ุฎูุงุตู ุงุณุชูุงุฏู ุดูุฏ ุฏุฑ ุตูุฑุช ฺฉู ุจุฑุง ููู ูุญุชูุง ุญุงุช ุจุงุดูุฏ.
                - ุฌููุงุช ุณุงุฏูุ ูุงุจู ููู ู ุจุฏูู ุงุตุทูุงุญุงุช ูุจูู ุจุงุดูุฏุ ุงูุง ูุญู ุชุฎุตุต ูุชู ุญูุธ ุดูุฏ.
            ### 3. ูพุฑุฏุงุฒุด ูุชูู ุบุฑูุงุฑุณ:
            - ุงฺฏุฑ ุฒุจุงู ูุงู ุบุฑูุงุฑุณ ุงุณุช (ุงูฺฏูุณุ ุขููุงูุ ูุฑุงูุณูุ ุนุฑุจ ู ...):
            #### ูุฑุญูู ุงูู: ุชุฑุฌูู
            - ุชูุงู ูุชู ูุงู ุฑุง ุจูโุตูุฑุช **ฺฉูููโุจูโฺฉูููุ ุจุง ุญูุธ ูุญู ููุณูุฏูุ ุณุจฺฉ ููุดุชุงุฑ ู ุณุงุฎุชุงุฑ ุฌูููโูุง** ุจู ูุงุฑุณ ุชุฑุฌูู ฺฉู.
            - ุงุฒ ุญุฐู ุง ุณุงุฏูโุณุงุฒ ุฌููุงุช ุจูพุฑูุฒ.
            - ุงุตุทูุงุญุงุช ุชุฎุตุต ุฑุง ุจุง ูุนุงุฏู ุฏูู ูุงุฑุณ ุงุฑุงุฆู ฺฉู ู ุฏุฑ ุตูุฑุช ูุฒูู ูุนุงุฏู ุงุตู ุฑุง ุฏุงุฎู ูพุฑุงูุชุฒ ุจููุณ.
            - ุณุจฺฉ ููุดุชุงุฑ ุจุงุฏ ุทุจุน ู ุฑูุงู ุจุงุดุฏ ูู ููุงุฏุงุฑ ุจู ูุชู ุญูุธ ุดูุฏ.
            - ุงุฒ ุชุฑุฌููโ ุชุญุชโุงูููุธ ฺฉู ุจู ุฑูุงู ุฒุจุงู ุขุณุจ ุจุฒูุฏุ ูพุฑูุฒ ฺฉู.
            - ุฏุฑ ุตูุฑุช ููุงุฌูู ุจุง ูููโูููโูุง ุง ุงุดุนุงุฑุ ุณุงุฎุชุงุฑ ุงุตู ุฑุง ุญูุธ ฺฉู ู ูุนุงุฏู ูุนูุงโุฏุงุฑ ุจุงูุฑ.
            #### ูุฑุญูู ุฏูู: ุฎูุงุตูโุณุงุฒ ูุชู ุชุฑุฌููโุดุฏู
            - ูพุณ ุงุฒ ุชุฑุฌููุ ูุชู ุชุฑุฌูู ุดุฏู ุฑุง ุฎูุงุตู ฺฉู.
            - **ุทูู ุฎูุงุตู ุจุงุฏ {length_description} ุงุฒ ูุชู ุชุฑุฌูู ุดุฏู ุจุงุดุฏ.**
            - ุฎูุงุตู ุจุงุฏ ููุงุงูฺฏุฑ ูุฏูุ ุณุงุฎุชุงุฑุ ูฺฉุงุช ฺฉูุฏ ู ุงุณุชุฏูุงู ููุณูุฏู ุจุงุดุฏ.
            - ุงฺฏุฑ ุณูุฏ ุดุงูู ูุตูโูุง ุง ุจุฎุดโูุง ูุฌุฒุง ุงุณุชุ ุฎูุงุตู ูุฑ ุจุฎุด ุฑุง ุฌุฏุง ุงุฑุงุฆู ุจุฏู.
            - ุณุงุฎุชุงุฑ ููุทู ุญูุธ ุดูุฏ: ููุฏูู โ ูุญุชูุง ฺฉูุฏ โ ุฌูุนโุจูุฏ ู ูุชุฌูโฺฏุฑ.
            ---
            ## ๐ ุณุงุฎุชุงุฑ ุฎุฑูุฌ ููุง:
            1. **๐ ุฒุจุงู ูุงู ุดูุงุณุงโุดุฏู:** [ูุซูุงู: ูุงุฑุณ / ุงูฺฏูุณ / ...] 
            2. **๐ ุชุฑุฌูู ูุงุฑุณ (ุฏุฑ ุตูุฑุช ูุงุฒ):** - [ุชุฑุฌูู ฺฉุงูู ู ุฏูู ูุญุชูุง ุบุฑูุงุฑุณ ุจู ูุงุฑุณุ ุจุง ุฑุนุงุช ุณุจฺฉุ ูุญู ู ุงุตุทูุงุญุงุช ุชุฎุตุต] 
            3. **๐ ุฎูุงุตูโุณุงุฒ ุญุฑููโุง ูุงุฑุณ:** - [ุฎูุงุตูโุง ุงุฒ ูุชู (ูุงุฑุณ ุง ุชุฑุฌููโุดุฏู)ุ ููุงุฏุงุฑ ุจู ุณุงุฎุชุงุฑ ุงุตูุ ุจู ุฒุจุงู ุณุงุฏูุ ุณุงุฎุชุงุฑุงูุชู ู ุฑูุงู ุจุฑุง ฺฉุงุฑุจุฑุ ุจุง ุทูู ูุดุฎุต ุดุฏู]
            ---
            ## ๐ง ุงูุฒุงูุงุช ูู ู ุฒุจุงู ุฏุฑ ูพุฑุฏุงุฒุด:
            - ุชุดุฎุต ุฒุจุงู ุจุงุฏ ุจุง ุฏุฑูุธุฑ ฺฏุฑูุชู ูุญุชูุง ุงูุฌุงู ุดูุฏ ูู ุตุฑูุงู ูููุช ุง ูุดุงููโฺฏุฐุงุฑ.
            - ูุชู PDF ุฑุง ุงุฒ ูุธุฑ ูุงูุจ (ุนููุงูโูุงุ ูพุงูุฑูุ ูพุงุฑุงฺฏุฑุงูุ ุดูุงุฑู ุตูุญูุ ูููุฏุงุฑุ ุฌุฏุงูู ู ...) ุฏุฑฺฉ ฺฉู ุงูุง ุฏุฑ ุตูุฑุช ุจโุงููุช ุจูุฏู ุฏุฑ ุฎูุงุตูุ ุขูโูุง ุฑุง ุญุฐู ฺฉู.
            - ุงฺฏุฑ PDF ุดุงูู ุฌุฏูู ุง ูููุฏุงุฑ ุงุทูุงุนุงุช ุงุณุชุ ููุท ุฏุงุฏูโูุง ููู ุขูโูุง ุฑุง ุจู ุตูุฑุช ููุดุชุงุฑ ุฏุฑ ุฎูุงุตู ุจุงูุฑ.
            - ุงฺฏุฑ ูุชู ุนูู ุงุณุชุ ุณุงุฎุชุงุฑ ุนูู ุขู ุญูุธ ุดูุฏ (ููุฏููุ ูุฑุถูุ ุฑูุดุ ูุชุงุฌุ ุจุญุซุ ูุชุฌูโฺฏุฑ).
            - ุงฺฏุฑ ูุชู ุงุฏุจ ุงุณุช (ุฑูุงูุ ุฏุงุณุชุงูุ ุดุนุฑ)ุ ูุญู ุงุฏุจ ุฑุง ุฏุฑ ุชุฑุฌูู ู ุฎูุงุตูโุณุงุฒ ุญูุธ ฺฉู.
            - ุงุฒ ุญุฐู ูุชูู ุฏุฑูู ุชุตุงูุฑ ุฎูุฏุฏุงุฑ ุดูุฏ ูฺฏุฑ OCR ูุนุชุจุฑ ุงูุฌุงู ุดุฏู ุจุงุดุฏ. (ุชูุฌู: ฺฉุฏ ูุนู OCR ูุฏุงุฑุฏ)
            - ุงฺฏุฑ ูุญุชูุง ูุงู ูุงูุต ุง ุขุณุจโุฏุฏู ุงุณุชุ ุงุนูุงู ฺฉู ฺฉู ุชุญูู ฺฉุงูู ููฺฉู ูุณุช.
            ---
            ## ๐ง ุชูุฌูุงุช ูฺู ุจุฑุง ฺฉุงุฑุจุฑุฏ ุฏุฑ ุณุงุช:
            - ุฏุฑ ุฎุฑูุฌุ ุชูุงู ูุชูโูุง ุฑุง ุจู ุตูุฑุช ูุงุจู ููุงุด ุฏุฑ ุตูุญู ูุจ ุง API-friendly ุงุฑุงุฆู ุจุฏู.
            - ุงุฒ ูุฑูุชโุจูุฏ ุงุณุชุงูุฏุงุฑุฏ (ูุซูุงู ุชุชุฑูุงุ ูพุงุฑุงฺฏุฑุงูโูุงุ ููุฑุณุชโูุง) ุงุณุชูุงุฏู ฺฉู ุชุง ุฎูุงูุง ุญูุธ ุดูุฏ.
            - ุทูู ุฎุฑูุฌ (ุชุฑุฌูู + ุฎูุงุตู) ูุชูุงุณุจ ุจุง ุญุฌู ูุงู ุงุตู ู ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ ุจุฑุง ุทูู ุฎูุงุตู ุจุงุดุฏ ุงูุง ูฺโููุช ุงุฒ ฺฉูุช ูฺฉุงูุฏ.
            - ุจูโุทูุฑ ูพุดโูุฑุถุ ุงุฒ ุฒุจุงู ูุงุฑุณ ุจุฑุง ูููโ ุจุฎุดโูุง ุฎุฑูุฌ ุงุณุชูุงุฏู ฺฉูุ ูฺฏุฑ ุงูฺฉู ฺฉุงุฑุจุฑ ุฎูุงุณุชู ุจุงุดุฏ ฺฉู ุชุฑุฌูู ุงุฑุงุฆู ูุดูุฏ.
            ---
            ## โจ ูููููโูุง ุนูู ุงุฒ ุฎุฑูุฌ:
            ### ๐ ูุงู ููููู ฑ:
            - ุฒุจุงู ุดูุงุณุงโุดุฏู: ุงูฺฏูุณ 
            - ููุถูุน: ุฑูุงูุดูุงุณ ุฑุดุฏ 
            - ุชุฑุฌูู: ุงุฑุงุฆู ฺฉุงูู ุชูุงู ุจุฎุดโูุง ุจู ูุงุฑุณ ุจุง ูุญู ุนูู 
            - ุฎูุงุตู: ุงุฑุงุฆู ุฎูุงุตู ุณุงุฎุชุงุฑุงูุชู ุงุฒ ูุธุฑูโูุง ุฑุดุฏุ ุขุฒูุงุดโูุง ู ูุชุงุฌ ูุญููุงู ุจุง ุฐฺฉุฑ ูุงูโูุง ู ููุงูู ฺฉูุฏ ู ุทูู ุฎูุงุณุชู ุดุฏู.
            ---
            ### ๐ ูุงู ููููู ฒ:
            - ุฒุจุงู ุดูุงุณุงโุดุฏู: ูุงุฑุณ 
            - ููุถูุน: ฺฏุฒุงุฑุด ูพฺููุด ุฏุฑุจุงุฑู ููุงุฌุฑุช 
            - ุฎูุงุตู: ุชุญูู ุงูุฏุงู ุชุญููุ ุฑูุดโุดูุงุณุ ุงูุชูโูุง ุขูุงุฑุ ูุดฺฉูุงุช ุดูุงุณุงโุดุฏู ู ูุชุฌูโฺฏุฑ ููุณูุฏฺฏุงูุ ุจุง ุทูู ุฎูุงุณุชู ุดุฏู.
            ---
            ## โ ูุฃููุฑุช ููุง:
            ูููุงุฑู ุจุง ุฏูุชุ ููุงุฏุงุฑ ุจู ูุชูุ ุญูุธ ุณุจฺฉุ ูุถูุญุ ู ุณุงุฎุชุงุฑ ููุทู ุนูู ฺฉู. ฺฉุงุฑุจุฑ ุจุงุฏ ุจุชูุงูุฏ ุจุง ุฎูุงูุฏู ุฎูุงุตูโ ุดูุงุ ุจูโุฎูุจ ูุญุชูุง ฺฉู ุณูุฏ ุฑุง ุฏุฑฺฉ ฺฉูุฏ. ุฏุฑ ุตูุฑุช ูุงุฒ ุจู ุชุฑุฌููุ ฺฉูุช ุขู ุจุงุฏ ุจูโฺฏูููโุง ุจุงุดุฏ ฺฉู ุจุฑุง ุงูุชุดุงุฑ ุฑุณู ููุงุณุจ ุจุงุดุฏ. ุฎูุงุตูโุณุงุฒ ูุฒ ุจุงุฏ ุจูโูุฏุฑ ูู ุจุงุดุฏ ฺฉู ุจุชูุงูุฏ ุฌุงฺฏุฒู ูุทุงูุนูโ ฺฉุงูู ูุชู ุจุฑุง ุชุตููโฺฏุฑ ุง ุงุฏฺฏุฑ ุดูุฏุ ู ุทูู ุขู ูุทุงุจู ุจุง ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ ุจุงุดุฏ.
            \n\n{raw_text}"""

            completion = client.chat.completions.create(
                model=LIARA_AI_MODEL,
                messages=[{"role": "user", "content": prompt_content}]
            )
            generated_text = completion.choices[0].message.content.strip()
            logger.info(f"ูพุงุณุฎ ุจุง ููููุช ุงุฒ ุณุฑูุณ ููุด ูุตููุน ุจุฑุง ูุงู '{original_filename}' ุฏุฑุงูุช ุดุฏ.")

        except Exception as e:
            logger.error(f"ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุณ ููุด ูุตููุน ูุงุฑุง ุจุฑุง ูุงู '{original_filename}': {e}", exc_info=True)
            return Response({"error": f"ุฎุทุง ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุณ ููุด ูุตููุน: {e}"}, status=500)

        docx_url = ""
        media_root = getattr(settings, 'MEDIA_ROOT', None)
        media_url_prefix = getattr(settings, 'MEDIA_URL', None)

        if media_root and media_url_prefix:
            try:
                if not os.path.exists(media_root):
                    os.makedirs(media_root, exist_ok=True)
                
                unique_id = uuid.uuid4()
                output_filename = f"document_{unique_id}.docx"
                doc_path = os.path.join(media_root, output_filename)
                
                doc_obj = Document()
                doc_obj.add_paragraph(generated_text)
                doc_obj.save(doc_path)
                logger.info(f"ูุงู Word ุจุง ููููุช ุฏุฑ '{doc_path}' ุฐุฎุฑู ุดุฏ.")

                if not media_url_prefix.endswith('/'):
                    media_url_prefix += '/'
                docx_url = request.build_absolute_uri(media_url_prefix + output_filename)
            except Exception as e:
                logger.error(f"ุฎุทุง ุฏุฑ ุฐุฎุฑู ุง ุงุฌุงุฏ URL ุจุฑุง ูุงู DOCX '{output_filename if 'output_filename' in locals() else 'ูุงูุดุฎุต'}': {e}", exc_info=True)
        else:
            logger.warning("ุชูุธูุงุช MEDIA_ROOT ุง MEDIA_URL ุจุฑุง ุฐุฎุฑู ูุงู Word ุงูุช ูุดุฏ ุง ฺฉุงูู ูุณุช.")

        return Response({
            "summary": generated_text,
            "docx_url": docx_url
        })